# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  name: mademitech

jobs:
  - job: buildJob
    displayName: "ðŸš€ Build Infra with Bastion Host"
    steps:
    - task: TerraformTask@5
      displayName: 'ðŸš€ Init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/$(INFRA_MODULE)'
        backendServiceArm: 'mademi-sc'
        backendAzureRmStorageAccountName: 'mademistg'
        backendAzureRmContainerName: 'mademitfstate'
        backendAzureRmKey: 'VmWithDocker.terraform.tfstate'
    - task: TerraformTask@5
      displayName: 'ðŸš€ Plan for Infra'
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(System.DefaultWorkingDirectory)/$(INFRA_MODULE)'
        environmentServiceNameAzureRM: 'mademi-sc'
    - task: TerraformTask@5
      displayName: 'ðŸš€ Infra Creation' 
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(System.DefaultWorkingDirectory)/$(INFRA_MODULE)'
        commandOptions: '--auto-approve'
        environmentServiceNameAzureRM: 'mademi-sc'
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'destroy'
        workingDirectory: '$(System.DefaultWorkingDirectory)/$(INFRA_MODULE)'
        commandOptions: '--auto-approve'
        environmentServiceNameAzureRM: 'mademi-sc'
    