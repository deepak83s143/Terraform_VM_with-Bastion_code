trigger:
- main

pool:
  name: mademitech

variables:
  INFRA_MODULE: 'terraform-modules/bastion-vm'

stages:

- stage: TerraformInit
  displayName: "ğŸ§± Terraform Init Stage"
  jobs:
  - job: initJob
    displayName: "ğŸ”§ Terraform Init"
    steps:
    - task: TerraformTask@5
      displayName: 'ğŸš€ Init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/$(INFRA_MODULE)'
        backendServiceArm: 'mademi-sc'
        backendAzureRmStorageAccountName: 'mademistg'
        backendAzureRmContainerName: 'mademitfstate'
        backendAzureRmKey: 'VmWithDocker.terraform.tfstate'

- stage: TerraformPlan
  displayName: "ğŸ“ Terraform Plan Stage"
  dependsOn: TerraformInit
  jobs:
  - job: planJob
    displayName: "ğŸ§ª Terraform Plan"
    steps:
    - task: TerraformTask@5
      displayName: 'ğŸš€ Plan for Infra'
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(System.DefaultWorkingDirectory)/$(INFRA_MODULE)'
        environmentServiceNameAzureRM: 'mademi-sc'

- stage: TerraformApply
  displayName: "âš™ï¸ Terraform Apply Stage"
  dependsOn: TerraformPlan
  jobs:
  - job: applyJob
    displayName: "ğŸš€ Terraform Apply"
    steps:
    - task: TerraformTask@5
      displayName: 'ğŸš€ Infra Creation' 
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(System.DefaultWorkingDirectory)/$(INFRA_MODULE)'
        commandOptions: '--auto-approve'
        environmentServiceNameAzureRM: 'mademi-sc'

